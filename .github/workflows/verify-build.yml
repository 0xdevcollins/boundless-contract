name: "Verify Build"

on:
  push:
    branches:
      - main
    paths:
      - 'contracts/**'
      - '.github/workflows/verify-build.yml'
  pull_request_target:
    branches:
      - main
    paths:
      - 'contracts/**'
      - '.github/workflows/verify-build.yml'
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable

      - name: Build contract
        run: cargo build --target wasm32-unknown-unknown --release

      - name: Verify Wasm file
        run: |
          if [ ! -f target/wasm32-unknown-unknown/release/boundless.wasm ]; then
            echo "Error: Wasm file not found"
            exit 1
          fi
          echo "Wasm file found and verified"

  rustfmt:
    needs: build
    if: success()
    uses: ./.github/workflows/rustfmt.yml
    with:
      permissions: |
        contents: read
        actions: read
        id-token: write
